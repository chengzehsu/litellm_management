name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate config.yaml
        run: |
          python -c "
          import yaml
          import sys
          try:
              with open('config.yaml', 'r') as f:
                  config = yaml.safe_load(f)
              print('âœ“ config.yaml is valid YAML')
              
              # Check required sections
              if 'general_settings' not in config:
                  print('âœ— Missing general_settings section')
                  sys.exit(1)
              if 'litellm_settings' not in config:
                  print('âœ— Missing litellm_settings section')
                  sys.exit(1)
              if 'success_callback' not in config.get('litellm_settings', {}):
                  print('âœ— Missing success_callback in litellm_settings')
                  sys.exit(1)
              if 'langfuse' not in config.get('litellm_settings', {}).get('success_callback', []):
                  print('âœ— Langfuse callback not configured')
                  sys.exit(1)
              print('âœ“ All required configuration sections present')
          except yaml.YAMLError as e:
              print(f'âœ— Invalid YAML: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'âœ— Error validating config: {e}')
              sys.exit(1)
          "

      - name: Check required files
        run: |
          required_files=("config.yaml" "requirements.txt" "Dockerfile" "start.sh" "README.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âœ— Missing required file: $file"
              exit 1
            else
              echo "âœ“ Found: $file"
            fi
          done

      - name: Validate Dockerfile
        run: |
          if ! grep -q "FROM python" Dockerfile; then
            echo "âœ— Dockerfile should use Python base image"
            exit 1
          fi
          if ! grep -q "litellm" requirements.txt; then
            echo "âœ— requirements.txt should include litellm"
            exit 1
          fi
          echo "âœ“ Dockerfile and requirements.txt are valid"

  test-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: litellm-proxy:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          echo "âœ“ Docker image built successfully"
          docker images litellm-proxy:test

  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install yamllint

      - name: Lint YAML files
        run: |
          # Use .yamllint config if it exists
          if [ -f .yamllint ]; then
            yamllint -c .yamllint config.yaml || true
          else
            yamllint config.yaml || true
          fi

      - name: Check shell script syntax
        run: |
          shellcheck start.sh || true

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          # Check for common secret patterns
          if grep -r "sk-[a-zA-Z0-9]" --include="*.yaml" --include="*.yml" --include="*.py" --include="*.sh" .; then
            echo "âš  Warning: Potential secrets found in code"
            echo "Please ensure all secrets are in environment variables, not in code"
          else
            echo "âœ“ No obvious secrets found in code"
          fi

      - name: Check .env files are not committed
        run: |
          if git ls-files | grep -q "\.env$"; then
            echo "âœ— .env file should not be committed to repository"
            exit 1
          else
            echo "âœ“ No .env files found in repository"
          fi

  # Zeabur deployment will be triggered automatically after all checks pass
  # Make sure you have connected the repository in Zeabur and enabled auto-deploy
  notify:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: [validate, test-build, lint, security]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Deployment notification
        run: |
          echo "âœ“ All checks passed!"
          echo "ðŸš€ Code is ready for deployment to Zeabur"
          echo ""
          echo "ðŸ“‹ Next steps:"
          echo "1. Ensure repository is connected in Zeabur"
          echo "2. Enable auto-deploy in Zeabur service settings"
          echo "3. Zeabur will automatically deploy this commit"
          echo ""
          echo "ðŸ”— Check deployment status:"
          echo "   - Zeabur Dashboard: https://zeabur.com"
          echo "   - GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All validation checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Services to Deploy:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **LiteLLM Proxy** (Root directory)" >> $GITHUB_STEP_SUMMARY
          echo "2. **Langfuse** (langfuse/ directory)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [Zeabur Dashboard](https://zeabur.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY

