name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate config.yaml
        run: |
          python -c "
          import yaml
          import sys
          try:
              with open('config.yaml', 'r') as f:
                  config = yaml.safe_load(f)
              print('✓ config.yaml is valid YAML')
              
              if 'general_settings' not in config:
                  print('✗ Missing general_settings section')
                  sys.exit(1)
              if 'litellm_settings' not in config:
                  print('✗ Missing litellm_settings section')
                  sys.exit(1)
              if 'success_callback' not in config.get('litellm_settings', {}):
                  print('✗ Missing success_callback in litellm_settings')
                  sys.exit(1)
              if 'langfuse' not in config.get('litellm_settings', {}).get('success_callback', []):
                  print('✗ Langfuse callback not configured')
                  sys.exit(1)
              print('✓ All required configuration sections present')
          except yaml.YAMLError as e:
              print(f'✗ Invalid YAML: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'✗ Error validating config: {e}')
              sys.exit(1)
          "

      - name: Check required files
        run: |
          echo "Checking LiteLLM Proxy files..."
          required_files=("config.yaml" "requirements.txt" "Dockerfile" "start.sh" "README.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "✗ Missing required file: $file"
              exit 1
            else
              echo "✓ Found: $file"
            fi
          done
          
          echo ""
          echo "Checking Langfuse files..."
          langfuse_files=("langfuse/Dockerfile" "langfuse/README.md" "langfuse/zeabur.json")
          for file in "${langfuse_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "✗ Missing required file: $file"
              exit 1
            else
              echo "✓ Found: $file"
            fi
          done

  test-build-litellm:
    name: Test LiteLLM Proxy Build
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build LiteLLM Proxy image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: litellm-proxy:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify image
        run: |
          echo "✓ LiteLLM Proxy image built successfully"
          docker images litellm-proxy:test

  test-build-langfuse:
    name: Test Langfuse Build
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Langfuse image
        uses: docker/build-push-action@v5
        with:
          context: ./langfuse
          push: false
          load: true
          tags: langfuse:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify image
        run: |
          echo "✓ Langfuse image built successfully"
          docker images langfuse:test

  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          if [ -f .yamllint ]; then
            yamllint -c .yamllint config.yaml || true
          else
            yamllint config.yaml || true
          fi

      - name: Check shell script syntax
        run: shellcheck start.sh || true

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          if grep -r "sk-[a-zA-Z0-9]" --include="*.yaml" --include="*.yml" --include="*.py" --include="*.sh" .; then
            echo "⚠ Warning: Potential secrets found in code"
          else
            echo "✓ No obvious secrets found in code"
          fi

      - name: Check .env files are not committed
        run: |
          if git ls-files | grep -q "\.env$"; then
            echo "✗ .env file should not be committed"
            exit 1
          else
            echo "✓ No .env files found"
          fi

  deploy:
    name: Ready for Deployment
    runs-on: ubuntu-latest
    needs: [validate, test-build-litellm, test-build-langfuse, lint, security]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## ✅ All Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Ready for Zeabur Deployment:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Directory | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL | Zeabur Marketplace | Deploy first |" >> $GITHUB_STEP_SUMMARY
          echo "| Langfuse | \`langfuse/\` | Ready |" >> $GITHUB_STEP_SUMMARY
          echo "| LiteLLM Proxy | \`/\` (root) | Ready |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Order:" >> $GITHUB_STEP_SUMMARY
          echo "1. Deploy PostgreSQL from Zeabur Marketplace" >> $GITHUB_STEP_SUMMARY
          echo "2. Deploy Langfuse (set DATABASE_URL)" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy LiteLLM Proxy (set LANGFUSE_HOST)" >> $GITHUB_STEP_SUMMARY
